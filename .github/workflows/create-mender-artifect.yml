name: Build Mender Artifact

on:
  workflow_dispatch:
    inputs:
      device_type:
        description: 'Device type'
        default: 'rugged'
      bump:
        description: 'Version bump'
        type: choice
        options:
          - minor
          - major

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # Install mender-artifact and dependencies
      # ---------------------------------------------------------
      - name: Install mender-artifact dependencies
        run: |
          sudo apt-get update
          sudo apt-get install --assume-yes \
              apt-transport-https \
              ca-certificates \
              curl \
              gnupg \
              jq

          curl -fsSL https://downloads.mender.io/repos/debian/gpg | sudo tee /etc/apt/trusted.gpg.d/mender.asc
          sudo sed -i.bak -e "\,https://downloads.mender.io/repos/workstation-tools,d" /etc/apt/sources.list

          echo "deb [arch=$(dpkg --print-architecture)] https://downloads.mender.io/repos/workstation-tools ubuntu/noble/stable main" \
            | sudo tee /etc/apt/sources.list.d/mender.list

          sudo apt-get update
          sudo apt-get install -y mender-artifact
      # ---------------------------------------------------------

      - name: Download installer script
        run: |
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
               -H "Accept: application/vnd.github.raw" \
               -o service-artifact-gen.sh \
               https://api.github.com/repos/${{ github.repository_owner }}/mender-service-installer/contents/service-artifact-gen.sh
          chmod +x service-artifact-gen.sh

      - name: Download bundle
        uses: dawidd6/action-download-artifact@v3
        with:
          name: wifi_api_server_bundle
          workflow: build.yml
          path: .

      - name: Extract bundle
        run: |
          tar -xzf wifi_api_server_bundle.tar.gz
          ls -R .

      - name: Compute version
        id: version
        run: |
          DEVICE="${{ inputs.device_type }}"

          # get latest matching tag like device-v1.4
          TAG=$(git tag --sort=-v:refname | grep -E "^${DEVICE}-v[0-9]+\.[0-9]+$" | head -1)

          if [ -z "$TAG" ]; then
            echo "No existing tags for $DEVICE, starting at 0.0"
            MAJOR=0
            MINOR=0
          else
            CURRENT="${TAG#${DEVICE}-v}"
            MAJOR=$(echo "$CURRENT" | cut -d. -f1)
            MINOR=$(echo "$CURRENT" | cut -d. -f2)
          fi

          if [ "${{ inputs.bump }}" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
          else
            MINOR=$((MINOR + 1))
          fi

          echo "version=${MAJOR}.${MINOR}" >> "$GITHUB_OUTPUT"

      - name: Build artifact
        run: |
          cat > install-config.txt << 'EOF'
          wifi_api_server|/usr/local/bin/wifi_api_server|executable
          ui|/app/wifi-connect/ui|folder
          index.html|/app/wifi-connect/index.html|regular
          wifi_api_server.service|service|service
          EOF
          
          NAME="wifi_connect-${{ inputs.device_type }}-v${{ steps.version.outputs.version }}"
          
          ./service-artifact-gen.sh \
            -d "${{ inputs.device_type }}" \
            -c install-config.txt \
            -n "$NAME" \
            -o "${NAME}.mender"

          echo "NAME=${NAME}" >> $GITHUB_ENV

      - name: Tag version
        run: |
          TAG="${{ inputs.device_type }}-v${{ steps.version.outputs.version }}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag "$TAG"
          git push origin "$TAG"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NAME }}.mender
          path: ${{ env.NAME }}.mender
          retention-days: 90

